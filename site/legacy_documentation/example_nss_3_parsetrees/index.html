<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Vignette 3: Storing Parsed Documents - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../documentation/ex_basics/" class="dropdown-item">Basics of doctable</a>
</li>
                                    
<li>
    <a href="../../documentation/ex_insert_delete/" class="dropdown-item">Insert and Delete Queries with doctable</a>
</li>
                                    
<li>
    <a href="../../documentation/ex_schemas/" class="dropdown-item">Table Schemas</a>
</li>
                                    
<li>
    <a href="../../documentation/ex_select/" class="dropdown-item">Select Queries with doctable</a>
</li>
                                    
<li>
    <a href="../../documentation/iris_example/" class="dropdown-item">Iris example</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Legacy documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../dataclass_example/" class="dropdown-item">Dataclass Schema Example</a>
</li>
                                    
<li>
    <a href="../dataclass_vignette_advanced/" class="dropdown-item">Advanced dataclass schema vignette</a>
</li>
                                    
<li>
    <a href="../depric_vignette_newsgroups/" class="dropdown-item">NewsGroups Dataset Vignette</a>
</li>
                                    
<li>
    <a href="../distributed_basics/" class="dropdown-item">Distribute Parallel Processing Basics</a>
</li>
                                    
<li>
    <a href="../doctable_basics/" class="dropdown-item">DocTable Overview</a>
</li>
                                    
<li>
    <a href="../doctable_bootstrap/" class="dropdown-item">Document Bootstrapping Examples</a>
</li>
                                    
<li>
    <a href="../doctable_concurrency/" class="dropdown-item">Concurrent Database Connections</a>
</li>
                                    
<li>
    <a href="../doctable_connectengine/" class="dropdown-item">Manage SQL Connections with DocTable</a>
</li>
                                    
<li>
    <a href="../doctable_file_column_types/" class="dropdown-item">DocTable File Column Types</a>
</li>
                                    
<li>
    <a href="../doctable_insert_delete/" class="dropdown-item">DocTable Examples: Insert and Delete</a>
</li>
                                    
<li>
    <a href="../doctable_multitable/" class="dropdown-item">Example: Multiple Tables</a>
</li>
                                    
<li>
    <a href="../doctable_parsetreedoc_column/" class="dropdown-item">ParseTreeDoc Column Types</a>
</li>
                                    
<li>
    <a href="../doctable_picklefile/" class="dropdown-item">DocTable Example: Pickle and Text Files</a>
</li>
                                    
<li>
    <a href="../doctable_schema/" class="dropdown-item">DocTable Schemas</a>
</li>
                                    
<li>
    <a href="../doctable_schema_dataclass/" class="dropdown-item">DocTable Example: Schemas</a>
</li>
                                    
<li>
    <a href="../doctable_schema_legacy/" class="dropdown-item">DocTable Schemas</a>
</li>
                                    
<li>
    <a href="../doctable_select/" class="dropdown-item">DocTable Examples: Select</a>
</li>
                                    
<li>
    <a href="../doctable_update/" class="dropdown-item">DocTable Examples: Update</a>
</li>
                                    
<li>
    <a href="../example_nss_1_intro/" class="dropdown-item">Vignette 1: Storing Document Metadata</a>
</li>
                                    
<li>
    <a href="../example_nss_2_parsing/" class="dropdown-item">Vignette 2: Storing Document Text</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Vignette 3: Storing Parsed Documents</a>
</li>
                                    
<li>
    <a href="../example_nss_intro_dataclass/" class="dropdown-item">Example 1: US National Security Strategy Document Corpus</a>
</li>
                                    
<li>
    <a href="../legacy_adv/" class="dropdown-item">DocTable (slightly more) Advanced Example</a>
</li>
                                    
<li>
    <a href="../legacy_simple/" class="dropdown-item">DocTable Simple Example</a>
</li>
                                    
<li>
    <a href="../parse_parsepipeline/" class="dropdown-item">ParsePipeline Basics</a>
</li>
                                    
<li>
    <a href="../parse_parsetrees/" class="dropdown-item">Working with doctable Parsetrees</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../example_nss_2_parsing/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../example_nss_intro_dataclass/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#vignette-3-storing-parsed-documents" class="nav-link">Vignette 3: Storing Parsed Documents</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#1-define-the-doctable-schema" class="nav-link">1. Define the DocTable Schema</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2-create-a-parser-class-using-a-pipeline" class="nav-link">2. Create a Parser Class Using a Pipeline</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3-work-with-parsetrees" class="nav-link">3. Work With Parsetrees</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="vignette-3-storing-parsed-documents">Vignette 3: Storing Parsed Documents</h1>
<p>Here I'll show how to make a DocTable for storing NSS documents at the paragraph level, and parse the documents in parallel.</p>
<p>For context, check out <a href="https://devincornell.github.io/doctable/examples/ex_nss.html">Example 1</a> - here we'll just use some shortcuts for code used there. These come from the util.py code in the repo examples folder.</p>
<p>These are the vignettes I have created:</p>
<ul>
<li>
<p><a href="example_nss_1_intro.html">1: Storing Document Metadata</a></p>
</li>
<li>
<p><a href="example_nss_2_parsing.html">2: Storing Document Text</a></p>
</li>
<li>
<p><a href="example_nss_3_parsetrees.html">3: Storing Parsed Documents</a></p>
</li>
</ul>
<pre><code class="language-python">import sys
sys.path.append('..')
#import util
import doctable
import spacy
from tqdm import tqdm

# automatically clean up temp folder after python ends
import tempfile
tempdir = tempfile.TemporaryDirectory()
tmpfolder = tempdir.name
tmpfolder
</code></pre>
<pre><code>'/tmp/tmp1isfmada'
</code></pre>
<p>First we define the metadata and download the text data.</p>
<pre><code class="language-python">import urllib
def download_nss(year):
    ''' Simple helper function for downloading texts from my nssdocs repo.'''
    baseurl = 'https://raw.githubusercontent.com/devincornell/nssdocs/master/docs/{}.txt'
    url = baseurl.format(year)
    text = urllib.request.urlopen(url).read().decode('utf-8')
    return text

document_metadata = [
    {'year': 2000, 'party': 'D', 'president': 'Clinton'},
    {'year': 2006, 'party': 'R', 'president': 'W. Bush'}, 
    {'year': 2015, 'party': 'D', 'president': 'Obama'}, 
    {'year': 2017, 'party': 'R', 'president': 'Trump'}, 
]

sep = '\n\n'
first_n = 10
for md in document_metadata:
    text = download_nss(md['year'])
    md['text'] = sep.join(text.split(sep)[:first_n])
print(f&quot;{len(document_metadata[0]['text'])=}&quot;)
</code></pre>
<pre><code>len(document_metadata[0]['text'])=6695
</code></pre>
<h2 id="1-define-the-doctable-schema">1. Define the DocTable Schema</h2>
<p>Now we define a doctable schema using the <code>doctable.schema</code> class decorator and the <a href="examples/doctable_file_column_types.html">pickle file column type</a> to prepare to store parsetrees as binary data.</p>
<pre><code class="language-python"># to be used as a database row representing a single NSS document
@doctable.schema
class NSSDoc:
    __slots__ = [] # include so that doctable.schema can create a slot class

    id: int = doctable.IDCol() # this is an alias for doctable.Col(primary_key=True, autoincrement=True)
    year: int =  doctable.Col()
    party: str = doctable.Col()
    president: str = doctable.Col()
    text: str = doctable.Col()
    doc: doctable.ParseTreeDoc = doctable.ParseTreeFileCol(f'{tmpfolder}/parsetree_pickle_files')
</code></pre>
<p>And a class to represent an NSS DocTable.</p>
<pre><code class="language-python">class NSSDocTable(doctable.DocTable):
    _tabname_ = 'nss_documents'
    _schema_ = NSSDoc

nss_table = NSSDocTable(target=f'{tmpfolder}/nss_3.db', new_db=True)
print(nss_table.count())
nss_table.schema_table()
</code></pre>
<pre><code>0


/DataDrive/code/doctable/examples/../doctable/doctable.py:402: UserWarning: Method .count() is depricated. Please use .q.count() instead.
  warnings.warn('Method .count() is depricated. Please use .q.count() instead.')
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>type</th>
      <th>nullable</th>
      <th>default</th>
      <th>autoincrement</th>
      <th>primary_key</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>id</td>
      <td>INTEGER</td>
      <td>False</td>
      <td>None</td>
      <td>auto</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>year</td>
      <td>INTEGER</td>
      <td>True</td>
      <td>None</td>
      <td>auto</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>party</td>
      <td>VARCHAR</td>
      <td>True</td>
      <td>None</td>
      <td>auto</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>president</td>
      <td>VARCHAR</td>
      <td>True</td>
      <td>None</td>
      <td>auto</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>text</td>
      <td>VARCHAR</td>
      <td>True</td>
      <td>None</td>
      <td>auto</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>doc</td>
      <td>VARCHAR</td>
      <td>True</td>
      <td>None</td>
      <td>auto</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>

<pre><code class="language-python">for md in document_metadata:
    nss_table.insert(md)
nss_table.head()
</code></pre>
<pre><code>/DataDrive/code/doctable/examples/../doctable/doctable.py:364: UserWarning: Method .insert() is depricated. Please use .q.insert_single(), .q.insert_single_raw(), .q.insert_multi(), or .q.insert_multi() instead.
  warnings.warn('Method .insert() is depricated. Please use .q.insert_single(), '
/DataDrive/code/doctable/examples/../doctable/doctable.py:390: UserWarning: .insert_single() is depricated: please use .q.insert_single() or .q.insert_single_raw()
  warnings.warn(f'.insert_single() is depricated: please use .q.insert_single() or '
/DataDrive/code/doctable/examples/../doctable/doctable.py:407: UserWarning: Method .head() is depricated. Please use .q.select_head() instead.
  warnings.warn('Method .head() is depricated. Please use .q.select_head() instead.')
/DataDrive/code/doctable/examples/../doctable/connectengine.py:69: SAWarning: TypeDecorator ParseTreeDocFileType() will not produce a cache key because the ``cache_ok`` attribute is not set to True.  This can have significant performance implications including some performance degradations in comparison to prior SQLAlchemy versions.  Set this attribute to True if this type object's state is safe to use in a cache key, or False to disable this warning. (Background on this error at: https://sqlalche.me/e/14/cprf)
  return self._engine.execute(query, *args, **kwargs)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>year</th>
      <th>party</th>
      <th>president</th>
      <th>text</th>
      <th>doc</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2000</td>
      <td>D</td>
      <td>Clinton</td>
      <td>As we enter the new millennium, we are blessed...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2006</td>
      <td>R</td>
      <td>W. Bush</td>
      <td>My fellow Americans, \n\nAmerica is at war. Th...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>2015</td>
      <td>D</td>
      <td>Obama</td>
      <td>Today, the United States is stronger and bette...</td>
      <td>None</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>2017</td>
      <td>R</td>
      <td>Trump</td>
      <td>An America that is safe, prosperous, and free ...</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="2-create-a-parser-class-using-a-pipeline">2. Create a Parser Class Using a Pipeline</h2>
<p>Now we create a small <code>NSSParser</code> class that keeps a <code>doctable.ParsePipeline</code> object for doing the actual text processing. As you can see from our init method, instantiating the package will load a spacy module into memory and construct the pipeline from the selected components. We also create a wrapper over the pipeline <code>.parse</code> and <code>.parsemany</code> methods. Here we define, instantiate, and view the components of <code>NSSParser</code>.</p>
<pre><code class="language-python">class NSSParser:
    ''' Handles text parsing for NSS documents.'''
    def __init__(self):
        nlp = spacy.load('en_core_web_sm')

        # this determines all settings for tokenizing
        self.pipeline = doctable.ParsePipeline([
            nlp, # first run spacy parser
            doctable.Comp('merge_tok_spans', merge_ents=True),
            doctable.Comp('get_parsetrees', **{
                'text_parse_func': doctable.Comp('parse_tok', **{
                    'format_ents': True,
                    'num_replacement': 'NUM',
                })
            })
        ])

    def parse(self, text):
        return self.pipeline.parse(text)

parser = NSSParser() # creates a parser instance
parser.pipeline.components
</code></pre>
<pre><code>[&lt;spacy.lang.en.English at 0x7fedee1c2cd0&gt;,
 functools.partial(&lt;function merge_tok_spans at 0x7fedf2d8f040&gt;, merge_ents=True),
 functools.partial(&lt;function get_parsetrees at 0x7fedf2d8f1f0&gt;, text_parse_func=functools.partial(&lt;function parse_tok at 0x7fedf2d82ee0&gt;, format_ents=True, num_replacement='NUM'))]
</code></pre>
<p>Now we parse the paragraphs of each document in parallel.</p>
<pre><code class="language-python">for doc in tqdm(nss_table.select(['id','year','text'])):
    parsed = parser.parse(doc.text)
    #print(parsed.as_dict())
    #break
    print(nss_table['doc'])
    nss_table.update({'doc': parsed}, where=nss_table['id']==doc.id, verbose=True)
#nss_table.select_df(limit=2)
</code></pre>
<pre><code>/DataDrive/code/doctable/examples/../doctable/doctable.py:443: UserWarning: Method .select() is depricated. Please use .q.select() instead.
  warnings.warn('Method .select() is depricated. Please use .q.select() instead.')
  0%|                                                                                                                                                      | 0/4 [00:00&lt;?, ?it/s]/DataDrive/code/doctable/examples/../doctable/doctable.py:489: UserWarning: Method .update() is depricated. Please use .q.update() instead.
  warnings.warn('Method .update() is depricated. Please use .q.update() instead.')
 25%|███████████████████████████████████▌                                                                                                          | 1/4 [00:00&lt;00:00,  3.83it/s]

nss_documents.doc
DocTable: UPDATE nss_documents SET doc=? WHERE nss_documents.id = ?
nss_documents.doc
DocTable: UPDATE nss_documents SET doc=? WHERE nss_documents.id = ?


100%|██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 4/4 [00:00&lt;00:00,  4.89it/s]

nss_documents.doc
DocTable: UPDATE nss_documents SET doc=? WHERE nss_documents.id = ?
nss_documents.doc
DocTable: UPDATE nss_documents SET doc=? WHERE nss_documents.id = ?
</code></pre>
<h2 id="3-work-with-parsetrees">3. Work With Parsetrees</h2>
<p>Now that we have stored our parsed text as files in the database, we can manipulate the parsetrees. This example shows the 5 most common nouns from each national security strategy document. This is possible because the <code>doctable.ParseTree</code> data structures contain <code>pos</code> information originally provided by the spacy parser. Using <code>ParseTreeFileType</code> allows us to more efficiently store pickled binary data so that we can perform these kinds of analyses at scale.</p>
<pre><code class="language-python">from collections import Counter # used to count tokens

for nss in nss_table.select():
    noun_counts = Counter([tok.text for pt in nss.doc for tok in pt if tok.pos == 'NOUN'])
    print(f&quot;{nss.president} ({nss.year}): {noun_counts.most_common(5)}&quot;)
</code></pre>
<pre><code>Clinton (2000): [('world', 9), ('security', 9), ('prosperity', 7), ('threats', 5), ('efforts', 5)]
W. Bush (2006): [('people', 4), ('world', 3), ('war', 2), ('security', 2), ('strategy', 2)]
Obama (2015): [('security', 15), ('world', 9), ('opportunities', 7), ('strength', 7), ('challenges', 7)]
Trump (2017): [('government', 5), ('principles', 4), ('peace', 3), ('people', 3), ('world', 3)]


/DataDrive/code/doctable/examples/../doctable/connectengine.py:69: SAWarning: TypeDecorator ParseTreeDocFileType() will not produce a cache key because the ``cache_ok`` attribute is not set to True.  This can have significant performance implications including some performance degradations in comparison to prior SQLAlchemy versions.  Set this attribute to True if this type object's state is safe to use in a cache key, or False to disable this warning. (Background on this error at: https://sqlalche.me/e/14/cprf)
  return self._engine.execute(query, *args, **kwargs)
</code></pre>
<p>Definitely check out this <a href="examples/doctable_parsetreedoc_column.html">example on parsetreedocs</a> if you're interested in more applications.</p>
<p>And that is all for this vignette! See the list of vignettes at the top of this page for more examples.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
