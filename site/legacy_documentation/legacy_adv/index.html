<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>DocTable (slightly more) Advanced Example - My Docs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">My Docs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../documentation/ex_basics/" class="dropdown-item">Basics of doctable</a>
</li>
                                    
<li>
    <a href="../../documentation/ex_insert_delete/" class="dropdown-item">Insert and Delete Queries with doctable</a>
</li>
                                    
<li>
    <a href="../../documentation/ex_schemas/" class="dropdown-item">Table Schemas</a>
</li>
                                    
<li>
    <a href="../../documentation/ex_select/" class="dropdown-item">Select Queries with doctable</a>
</li>
                                    
<li>
    <a href="../../documentation/iris_example/" class="dropdown-item">Iris example</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Legacy documentation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../dataclass_example/" class="dropdown-item">Dataclass Schema Example</a>
</li>
                                    
<li>
    <a href="../dataclass_vignette_advanced/" class="dropdown-item">Advanced dataclass schema vignette</a>
</li>
                                    
<li>
    <a href="../depric_vignette_newsgroups/" class="dropdown-item">NewsGroups Dataset Vignette</a>
</li>
                                    
<li>
    <a href="../distributed_basics/" class="dropdown-item">Distribute Parallel Processing Basics</a>
</li>
                                    
<li>
    <a href="../doctable_basics/" class="dropdown-item">DocTable Overview</a>
</li>
                                    
<li>
    <a href="../doctable_bootstrap/" class="dropdown-item">Document Bootstrapping Examples</a>
</li>
                                    
<li>
    <a href="../doctable_concurrency/" class="dropdown-item">Concurrent Database Connections</a>
</li>
                                    
<li>
    <a href="../doctable_connectengine/" class="dropdown-item">Manage SQL Connections with DocTable</a>
</li>
                                    
<li>
    <a href="../doctable_file_column_types/" class="dropdown-item">DocTable File Column Types</a>
</li>
                                    
<li>
    <a href="../doctable_insert_delete/" class="dropdown-item">DocTable Examples: Insert and Delete</a>
</li>
                                    
<li>
    <a href="../doctable_multitable/" class="dropdown-item">Example: Multiple Tables</a>
</li>
                                    
<li>
    <a href="../doctable_parsetreedoc_column/" class="dropdown-item">ParseTreeDoc Column Types</a>
</li>
                                    
<li>
    <a href="../doctable_picklefile/" class="dropdown-item">DocTable Example: Pickle and Text Files</a>
</li>
                                    
<li>
    <a href="../doctable_schema/" class="dropdown-item">DocTable Schemas</a>
</li>
                                    
<li>
    <a href="../doctable_schema_dataclass/" class="dropdown-item">DocTable Example: Schemas</a>
</li>
                                    
<li>
    <a href="../doctable_schema_legacy/" class="dropdown-item">DocTable Schemas</a>
</li>
                                    
<li>
    <a href="../doctable_select/" class="dropdown-item">DocTable Examples: Select</a>
</li>
                                    
<li>
    <a href="../doctable_update/" class="dropdown-item">DocTable Examples: Update</a>
</li>
                                    
<li>
    <a href="../example_nss_1_intro/" class="dropdown-item">Vignette 1: Storing Document Metadata</a>
</li>
                                    
<li>
    <a href="../example_nss_2_parsing/" class="dropdown-item">Vignette 2: Storing Document Text</a>
</li>
                                    
<li>
    <a href="../example_nss_3_parsetrees/" class="dropdown-item">Vignette 3: Storing Parsed Documents</a>
</li>
                                    
<li>
    <a href="../example_nss_intro_dataclass/" class="dropdown-item">Example 1: US National Security Strategy Document Corpus</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">DocTable (slightly more) Advanced Example</a>
</li>
                                    
<li>
    <a href="../legacy_simple/" class="dropdown-item">DocTable Simple Example</a>
</li>
                                    
<li>
    <a href="../parse_parsepipeline/" class="dropdown-item">ParsePipeline Basics</a>
</li>
                                    
<li>
    <a href="../parse_parsetrees/" class="dropdown-item">Working with doctable Parsetrees</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../example_nss_intro_dataclass/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../legacy_simple/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#doctable-slightly-more-advanced-example" class="nav-link">DocTable (slightly more) Advanced Example</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#get-news-data-from-sklearndatasets" class="nav-link">Get News Data From sklearn.datasets</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#define-newsgroups-doctable" class="nav-link">Define NewsGroups DocTable</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#update-tokenized_text-column" class="nav-link">Update "tokenized_text" Column</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#extract-email-metadata" class="nav-link">Extract Email Metadata</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="doctable-slightly-more-advanced-example">DocTable (slightly more) Advanced Example</h1>
<p>In this notebook, I show how to define a DocTable with blob data types, add new rows, and then iterate through rows to populate previously empty fields.</p>
<pre><code class="language-python">import email
from .legacy_helper import get_sklearn_newsgroups # for this example

import sys
sys.path.append('..')
import doctable as dt # this will be the table object we use to interact with our database.

tempfolder = dt.TempFolder('tmp')
</code></pre>
<h2 id="get-news-data-from-sklearndatasets">Get News Data From sklearn.datasets</h2>
<p>Then parses into a dataframe.</p>
<pre><code class="language-python">ddf = get_sklearn_newsgroups()
print(ddf.shape)
ddf.head(3)
</code></pre>
<pre><code>(11314, 3)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>filename</th>
      <th>target</th>
      <th>text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>21379</td>
      <td>soc.religion.christian</td>
      <td>From: kbanner@philae.sas.upenn.edu (Ken Banner...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>20874</td>
      <td>soc.religion.christian</td>
      <td>From: simon@monu6.cc.monash.edu.au\nSubject: S...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>58936</td>
      <td>sci.med</td>
      <td>From: jeffp@vetmed.wsu.edu (Jeff Parke)\nSubje...</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="define-newsgroups-doctable">Define NewsGroups DocTable</h2>
<p>This definition includes fields file_id, category, raw_text, subject, author, and tokenized_text. The extra columns compared to example_simple.ipynb are for storing extracted metadata.</p>
<pre><code class="language-python">class NewsGroups(dt.DocTableLegacy):
    def __init__(self, fname):
        '''
            DocTable class.
            Inputs:
                fname: fname is the name of the new sqlite database that will be used for instances of class.
        '''
        tabname = 'newsgroups'
        super().__init__(
            fname=fname, 
            tabname=tabname, 
            colschema=(
                'id integer primary key autoincrement',
                'file_id int', 
                'category string',
                'raw_text string',
                'subject string', 
                'author string', 
                'tokenized_text blob', 
            ),
            constraints=('UNIQUE(file_id)',)
        )

        # create indices on file_id and category
        self.query(&quot;create index if not exists idx1 on &quot;+tabname+&quot;(file_id)&quot;)
        self.query(&quot;create index if not exists idx2 on &quot;+tabname+&quot;(category)&quot;)
</code></pre>
<pre><code class="language-python">sng = NewsGroups(f'{tmp}/news_groupssss.db')
print(sng)
</code></pre>
<pre><code>&lt;Documents ct: 0&gt;
</code></pre>
<pre><code class="language-python"># add in raw data
col_order = ('file_id','category','raw_text')
data = [(dat['filename'],dat['target'],dat['text']) for ind,dat in ddf.iterrows()]
sng.addmany(data,keys=col_order, ifnotunique='ignore')
sng.getdf(limit=2)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>file_id</th>
      <th>category</th>
      <th>raw_text</th>
      <th>subject</th>
      <th>author</th>
      <th>tokenized_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>21379</td>
      <td>soc.religion.christian</td>
      <td>From: kbanner@philae.sas.upenn.edu (Ken Banner...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>20874</td>
      <td>soc.religion.christian</td>
      <td>From: simon@monu6.cc.monash.edu.au\nSubject: S...</td>
      <td>None</td>
      <td>None</td>
      <td>None</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="update-tokenized_text-column">Update "tokenized_text" Column</h2>
<p>Use .get() to loop through rows in the database, and .update() to add in the newly extracted data. In this case, we simply tokenize the text using the python builtin split() function.</p>
<pre><code class="language-python">query = sng.get(sel=('file_id','raw_text',))
for row in query:

    dat = {'tokenized_text':row['raw_text'].split(),}
    sng.update(dat, 'file_id == {}'.format(row['file_id']))
sng.getdf(limit=2)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>file_id</th>
      <th>category</th>
      <th>raw_text</th>
      <th>subject</th>
      <th>author</th>
      <th>tokenized_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>21379</td>
      <td>soc.religion.christian</td>
      <td>From: kbanner@philae.sas.upenn.edu (Ken Banner...</td>
      <td>None</td>
      <td>None</td>
      <td>[From:, kbanner@philae.sas.upenn.edu, (Ken, Ba...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>20874</td>
      <td>soc.religion.christian</td>
      <td>From: simon@monu6.cc.monash.edu.au\nSubject: S...</td>
      <td>None</td>
      <td>None</td>
      <td>[From:, simon@monu6.cc.monash.edu.au, Subject:...</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="extract-email-metadata">Extract Email Metadata</h2>
<p>This example takes it even further by using the "email" package to parse apart the blog files. It then uses the extracted information to populate the corresponding fields in the DocTable.</p>
<pre><code class="language-python">query = sng.get(sel=('file_id','raw_text',), asdict=False)
for fid,text in query:
    e = email.message_from_string(text)
    auth = e['From'] if 'From' in e.keys() else ''
    subj = e['Subject'] if 'Subject' in e.keys() else ''
    tok = e.get_payload().split()
    dat = {
        'tokenized_text':tok,
        'author':auth,
        'subject':subj,
    }

    sng.update(dat, 'file_id == {}'.format(fid))
sng.getdf(limit=2)
</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>file_id</th>
      <th>category</th>
      <th>raw_text</th>
      <th>subject</th>
      <th>author</th>
      <th>tokenized_text</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>21379</td>
      <td>soc.religion.christian</td>
      <td>From: kbanner@philae.sas.upenn.edu (Ken Banner...</td>
      <td>Re: SATANIC TOUNGES</td>
      <td>kbanner@philae.sas.upenn.edu (Ken Banner)</td>
      <td>[In, article, &lt;May.5.02.53.10.1993.28880@athos...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>20874</td>
      <td>soc.religion.christian</td>
      <td>From: simon@monu6.cc.monash.edu.au\nSubject: S...</td>
      <td>Saint Story St. Aloysius Gonzaga</td>
      <td>simon@monu6.cc.monash.edu.au</td>
      <td>[Heres, a, story, of, a, Saint, that, people, ...</td>
    </tr>
  </tbody>
</table>
</div>

<pre><code class="language-python">sng.getdf().to_csv('newsgroup20.csv')
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/jquery-3.6.0.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
